<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/isw-dialog/isw-dialog.html">
<link rel="import" href="../bower_components/isw-dialog/isw-dialog-remote.html">
<link rel="import" href="../bower_components/show-more/show-more.html">
<link rel="import" href="../bower_components/show-more/show-more.html">

<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">




<link rel="import" href="devocional-editor.html">
<link rel="import" href="devocional-item.html">

<dom-module id="devocional-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }
      :host([hidden]), [hidden] {
        display: none !important;
      }
      paper-button {
                border-radius: 5px;
                background-color: var(--app-primary-color);
                margin: auto;
                color:white;
            }
            paper-fab {
        background-color: var(--app-primary-color,red);
        width: 80px;
        height: 80px;
            padding: 3px;
            position: fixed;
            right: 24px;
            bottom: 24px;
            
         --paper-fab-iron-icon: {
            height: 48px;
            width: 48px;
             
             };
  }
    </style>
    <iron-ajax 
        auto 
        url="src/biblia-struct.json" 
        handle-as="json" 
        last-response="{{bibleajax}}"
        >
      </iron-ajax>
      <firebase-document
            id="document"
            app-name="Cuaderno Devocional Rhema"
            path="[[editabledevocionalId]]"
            data="{{editableDevocional}}">
      </firebase-document>
      <firebase-query
         id="query"
         app-name="Cuaderno Devocional Rhema"
         path="/devocional/[[user.uid]]/cuadernoDevocional"
         data="{{devocionalItems}}">
      </firebase-query>   
        <app-indexeddb-mirror
          session="[[user.uid]]"
          key="notes"
          data="{{devocionalItems}}"
          persisted-data="{{persistedDevocionalItems}}">
        </app-indexeddb-mirror>  

   <!-- <devocional-editor name="editor">
    </devocional-editor>-->
    <!--<dom-repeat items$="{{_descending(persistedDevocionalItems)}}" >
        <template>
            <devocional-item id="{{item.index}}" 
            index="{{item.index}}" 
            date="[[item.year]]" 
            book="[[item.libro]]" 
            bible-struct="[[bibleajax]]"
            chapter="[[item.capitulo]]" 
            is-selected="{{item.selected}}" 
            on-selected="itemSelected" 
            on-delete="deleteItem">
              </devocional-item>
          </template>
      </dom-repeat> -->
      <div id="showlist" >
        <dom-repeat id="listrepeat" items$="{{getPages(persistedDevocionalItems,selectedPage)}}" >
          <template>
              <devocional-item id="{{item.index}}" 
              index="{{item.index}}" 
              item="[[item]]" 
              bible-struct="[[bibleajax]]"
              is-selected="{{item.selected}}" 
              on-selected="itemSelected"
              on-openeditor="openEditor" 
              on-delete="deleteItem">
                </devocional-item>
            </template>
        </dom-repeat>
        <div style="margin-top:10px; display: flex;">
          <paper-button id="back" disabled="[[canGoBack(devocionalPages)]]" on-tap="backPage">
            <iron-icon icon="arrow-back" ></iron-icon> 
          </paper-button>
          <div style="color:#383838; 
                text-align: center;
                font-size: 20px;"><strong>{{selectedPageShow(selectedPage)}}</strong></div>
          <paper-button id="leer" style="float:right;" disabled="[[canGoFoward(devocionalPages)]]" on-tap="nextPage">
            <iron-icon icon="arrow-forward" ></iron-icon> 
          </paper-button> 
        </div>
        <paper-fab
      icon="note-add"
      elevation="2"
      on-tap="createEditor">
      </paper-fab>
      </div>
      <devocional-editor id="editor" hidden editor-item="{{editorItem}}" bibleajax="{{bibleajax}}" user="{{user}}">

      </devocional-editor>


       

      <isw-dialog-remote
        id="dialogRemote"
        dialog="deleteDialog"
        data="{{dataForDialog}}"
        on-iron-overlay-canceled="_canceled"
        on-iron-overlay-closed="_closed"
        on-iron-overlay-opened="_opened">
      </isw-dialog-remote>
      
  </template>

  <script>
    class DevocionalView extends Polymer.Element {
      static get is() { return 'devocional-view'; }
      static get properties(){
                return {
                  lastSelected:{
                      type: Object
                  },
                  lastId:{
                    type:String
                  },
                  devocionalItems:{
                      type: Array,
                      value:[{date:"01/04/2017"},{date:"10/05/2018", book:"S.Juan",chapter:"2"},{date:"test"},{date:"10/05/2018", book:"S.Juan",chapter:"2"}]
                  },
                  user:{
                    type:Object
                  },
                  persistedDevocionalItems:{
                    type:Array,
                    value:[]
                  },
                  selectedPage:{
                    type:Number,
                    value:0
                  },
                  devocionalPages:{
                    type:Array,
                    value:[]
                  },
                  editorItem:{
                    type:Object,
                    value:{}
                  }       
          };
        }
      ready(){
      	super.ready();

      }
      
      itemSelected(e){ 
      	if(this.lastSelected !== e.model && this.lastSelected){
      	  this.lastSelected.set('item.selected',false);
            // this.lastSelected.set('item.date',"date");
          }
      	this.lastSelected = e.model;
        //this.openEditor(e.target.item);
        console.log(e.target.item);
      }
      deleteItem(e){
          console.log("view delete "+e.target.date +"index"+e.model.index);
          console.log( "opening remote" );
          this.dataForDialog={"date":e.target.date,"index":e.model.index};
				this.$.dialogRemote.open();
      }
      openRemote() {
				console.log( "opening remote" );
                this.dataForDialog={"date":this.date,"index":this.index};
				this.$.dialogRemote.open();
			}
			
      _canceled( event ) {
						console.log( "canceled");
					}

			_closed( event ) {
            console.debug("canceled "+ event.target.data.canceled);
            if(event.target.data.canceled){
              console.debug("canceled ")

            }else{
              var index=event.target.data.index;
              var item=this.devocionalItems[index];
              item.date="aaaa";
              this.splice('devocionalItems', index, 1,{date:item.date,book:item.book,chapter:item.chapter});
              console.log( "closed" );
              console.log(this.devocionalItems[index]);
                          
              console.log( event.target.data.index + " deleted");
              }
            
                       
					}

					_opened( event ) {
						//console.log( "opened" );
                        }
           _descending(data) {
            return data.reverse();
          }

          splitArrayData(array){
            var size = 30 // items per chunk 
            var inputArray=array.slice();
            
            var myArray = [];
              for(var i = 0; i < array.length; i += size) {
                myArray.push(array.slice(i, i+size));
              }
            console.log(myArray);
            //console.log(inputArray);
            return myArray;
          }
          getPages(array,index){
            var fixedArray=this._descending(array);
            this.devocionalPages=this.splitArrayData(fixedArray);
            
            return this.devocionalPages[index];
          }
          
          canGoFoward(){
            var next=this.selectedPage+1;
                if(next>this.devocionalPages.length){
                  return true;
                }else{
                  return false;
                }
            }
          canGoBack(){
              var back=this.selectedPage-1;
                if(back<0){
                  return true;
                }else{
                  return false;
                }
            }
            nextPage(){
              this.selectedPage+=1;
            }
            backPage(){
              this.selectedPage-=1;
            }
            selectedPageShow(page){
              return page+1;
            }
            openEditor(e){
              const event = new CustomEvent('openeditor', { bubbles: true, composed: true});
             this.dispatchEvent(event);
              this.$.editor.setItem(e.target.item);
              this.$.editor.hidden=false;
              this.$.showlist.hidden=true;
              
            }
            createEditor(e){
              const event = new CustomEvent('openeditor', { bubbles: true, composed: true});
             this.dispatchEvent(event);
              this.$.editor.createItem(this.devocionalItems[0]);
              this.$.editor.hidden=false;
              this.$.showlist.hidden=true;
              
            }
            closeEditor(){
              this.$.editor.save();
              this.$.editor.hidden=true;
              this.$.showlist.hidden=false;
            }
    }

    window.customElements.define(DevocionalView.is, DevocionalView);
  </script>
</dom-module>